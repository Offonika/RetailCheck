# Бот-флоу и сценарии

Документ описывает пользовательские сценарии Telegram-бота: состояние диалога, переходы и служебные ветки. Используется разработчиками при реализации FSM (finite state machine) и UX-сообщений.

## 1. Нотация
- **Состояния** — верхний регистр (`IDLE`, `STEP_INPUT`, `SUMMARY`, …).
- **Действия** — команды/кнопки (`/start`, «Далее», инлайн-кнопки).
- **Условия** — логические проверки (валидации, права).
- FSM реализуется на стороне бота (aiogram FSM + Redis). Для менеджеров и сотрудников используется одна FSM с разными ветками по роли.

## 2. Онбординг (`/start`)
1. Пользователь нажимает `/start`.
2. Бот проверяет `tg_id` в листе `Users`.  
   - Если не найден → сообщение «Доступ ограничен, обратитесь к менеджеру».
   - Если роль `manager` → отображаются команды менеджера (см. ниже).
   - Если роль `employee` → бот предлагает «Начать смену» (если есть открытые Runs).
3. Переход в состояние `IDLE`.

## 3. Сценарий сотрудника

### 3.1 Выбор смены
- **Триггер:** команда «Начать смену» или автоматическое приглашение.
- Бот ищет в Runs строки со статусом `in_progress`, shop_id ∈ shops пользователя.
- Если смен нет → сообщение «Нет активных смен, дождитесь менеджера» (возврат `IDLE`).
- Если одна смена → переход к `STEP_INPUT` с `current_step = first required step`. Несколько → бот показывает список inline-кнопок `[Магазин, дата]`.

### 3.2 Ввод шагов (`STEP_INPUT`)
Для каждого шага TemplateSteps:
1. Бот отправляет текст «Шаг X из N: <title>» + подсказку.
2. Пользователь вводит данные или загружает фото.
3. Валидации:
   - `number`: преобразование числа, проверка min/max.
   - `text`: длина, запрещённые символы.
   - `photo`: наличие `telegram_file_id`.
4. При ошибке бот выводит причину, остаётся в `STEP_INPUT`.
5. После успешного ввода:
   - Рассчитываем `delta`.
   - Если |delta| ≥ threshold → переходим в под-состояние `WAIT_COMMENT`. Пользователь обязан отправить комментарий → возврат в `STEP_INPUT`.
   - Иначе записываем значение в `RunSteps`, показываем «Ок / дельта: …».
6. Пользователь жмёт «Далее». FSM переходит к следующему шагу.
7. Кнопка «Назад» доступна: загружает значения из `RunSteps`, разрешает исправить.
8. Кнопка «Пропустить» доступна только если `required = FALSE`.

### 3.3 Итог (`SUMMARY`)
1. После последнего обязательного шага бот предлагает «Итог».
2. Перед формированием summary проверяем:
   - все обязательные шаги `status = ok`;
   - нет шагов в `WAIT_COMMENT`;
   - все фото-шаги имеют вложения.
3. Если проверки не пройдены → бот возвращает на первый проблемный шаг.
4. При успехе бот показывает сводку: кассы 11/16/19, терминалы, итоговая дельта, комментарии.
5. Кнопка «Отправить менеджеру»:
   - Обновляет `Runs.status = done`, `finished_at = now`.
   - Отправляет менеджеру message + inline «Вернуть/Экспорт/Ок».
   - Записывает Audit `run_completed`.
6. FSM возвращается в `IDLE`.

## 4. Сценарий менеджера

### 4.1 Создание смены
1. Команда «Создать смену».
2. Бот показывает список магазинов менеджера.
3. После выбора — спрашивает шаблон/дату (по умолчанию сегодня, шаблон «Вечерняя смена»).
4. Создаёт запись в Runs (`status = in_progress`), назначает сотрудников магазина.
5. Отправляет сотрудникам приглашение «Начать смену».

### 4.2 Мониторинг и возврат
1. Команда «Статус смен».
2. Бот выводит таблицу: магазин, прогресс (окончено/шаги), дельты.
3. С кнопки «Вернуть на доработку»:
   - Менеджер выбирает причину.
   - `Runs.status = returned`, проблемные `RunSteps.status = error`.
   - Сотрудник получает уведомление с перечнем шагов для исправления.

### 4.3 Подтверждение итога
1. Когда сотрудник завершил смену, менеджер получает summary.
2. Кнопки:
   - «Ок» — просто подтверждение, статус остаётся `done`.
   - «Вернуть» — см. выше.
   - «Экспорт за день/неделю» — запускает Export Builder.

## 5. Напоминания
- Scheduler хранит расписание слотов (по умолчанию 11:00 / 16:00 / 19:00).
- В заданный слот:
  1. Собираем Runs со статусом `in_progress`, где `required_steps_pending > 0`.
  2. Для каждого магазина отправляем сообщение сотрудникам «Пора заполнить…».
  3. Флаг `reminder_state[slot] = sent`, чтобы избежать дубликатов.
- Если смена закрыта → флаг сбрасывается (новая смена = новое состояние).

## 6. Ошибки и эскалации
- **Проблема записи в Sheets:** бот сообщает «техническая задержка», кладёт событие в очередь повторов. Пользователь остаётся на текущем шаге, идентификатор шага повторно отсылается после успешной записи.
- **Файл фото недоступен:** бот запрашивает повторную загрузку и не продвигает шаг.
- **Неизвестная команда:** бот выводит help с доступными командами по роли.

## 7. Тестовые сценарии (до разработки)
1. Сотрудник проходит все типы шагов (число, текст, чек, фото) → проверяем дельты, комментарии, итог.
2. Менеджер создаёт и возвращает смену → убеждаемся, что статус и шаги меняются корректно.
3. Напоминание в 11:00 для незавершённой смены → сообщение приходит только один раз до закрытия.
4. Экспорт за день по кнопке → лист `Export` обновляется, Audit фиксирует событие.
5. Ошибка Google API → ретраи и уведомление, состояние диалога сохраняется.

Этот документ служит основой для реализации FSM и написания unit/e2e-тестов. Любые изменения в UX обязательно отражаем здесь перед код-ревью.
