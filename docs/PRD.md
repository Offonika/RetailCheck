PRD — «Чек-лист-бот для смен» (Telegram + Google Sheets)
1. Обзор
Цель: заменить Excel-чек-листы на пошаговый бот в Telegram. Сотрудник вводит суммы/галочки/фото, бот проверяет и пишет всё в Google Таблицу. Менеджер получает сводку и может выгружать отчёты за день/неделю.
Ключевая ценность: меньше ошибок и переписок, быстрый итог смены, единое место правды — Google Таблица.

2. Пользователи и роли
Сотрудник магазина — проходит чек-лист, прикладывает фото, комментирует расхождения.


Менеджер — запускает смену, получает сводку/файл, видит историю, может вернуть на доработку.


Бухгалтер/контролёр (опционально) — читает лист «Export».

Пилот охватывает два магазина: `shop_1` («Ногмова») и `shop_2` («Искож»). Оба работают в таймзоне `Europe/Moscow`; один сотрудник может при необходимости завершать и открытие, и закрытие в один день.

2.1 Доступы и whitelist
- Во всех магазинах пилота `allow_anyone = FALSE`. Запустить роль могут только пользователи, чьи `telegram_username` перечислены в `manager_usernames` или `employee_usernames` магазина.
- Кросс-подмены выполняются через списки сотрудников: чтобы временно работать в другом магазине, username добавляют в `employee_usernames` второго магазина. Поле `allow_anyone` зарезервировано под будущие сценарии (тесты, обучение) и не меняет логику пилота.
- Менеджеры (`manager_usernames`) имеют право открывать/закрывать смену, делать handover и возвраты во всех закреплённых магазинах.
- Попытка старта смены пользователем вне whitelist отклоняется текстом «Вы не числитесь в списке сотрудников магазина. Обратитесь к менеджеру для допуска.»



3. Объём работ (MVP)
- Единственный run на `(shop_id, date)`; роли `opener` и `closer` назначаются автоматически по первому нажатию «Начать смену/закрытие».
- Дневной чек-лист одинаковый для A и B (две кассы): после «Начать смену» A проходит все шаги, после «Продолжить смену» B получает тот же набор, кроме `cash_start` и `photo_x_report`. Закрытие содержит только «Начать закрытие» и «Фото Z-отчёта».
- Типы шагов: число, текст, галочка, фото, выбор терминала. Обязательные фото: X-отчёт (A) и Z-отчёт (B); фото эквайринга/ведомости/терминала делаются в конце дневных шагов до закрытия.
- Проверки: формат числа, диапазоны/пределы, комментарий при |delta| ≥ порога, запрет `Runs.status = closed` без фото.
- Итог смены: сводка в общий магазинный чат (менеджер + исполнители) и запись в Таблицу (Runs/RunSteps/Attachments/Audit/Export) с opener/closer.
- Напоминания цикличные до завершения обязательных шагов (см. раздел 7): A — 15/30/каждые 45 мин, после 18:00 каждые 10 мин; B — 15/25/каждые 30 мин, после 20:00 каждые 10 мин; закрытие — 10/20/каждые 30 мин после «Начать закрытие».
- История и статусы: `opened → in_progress → ready_to_close → closed`, `returned` для возврата.
- Экспорт в лист «Export» (день/неделя) по кнопке с полями opener/closer/дельта.
- ККМ: по умолчанию одна касса на магазин; все кассовые шаги относятся к ней (без разделения по устройствам).
- Онбординг и локализация: `/start` (без payload) показывает локализованное приветствие и пагинированный список доступных магазинов с двумя CTA («Открыть смену», «Начать закрытие») и кнопкой «Ещё…» для перехода к `/menu`. Все тексты (`start.*`, `menu.*`, ошибки) берутся из `locale/ru/messages.json`; deep-link `?start=shop_<id>__open|__close` минует список и сразу назначает роль.

### 3.1 Чек-лист по ролям
**Дневные шаги (A и B выполняют одинаково)**

| code | title | type | required | owner_role |
| --- | --- | --- | --- | --- |
| `cash_start` | Начальный остаток кассы | number | true | opener |
| `photo_x_report` | Фото X-отчёта | photo | true | opener |
| `cash_check_1` | Сверка остатка №1 | number | true | both |
| `credit_check_1` | Проверка кредитов №1 | number | true | both |
| `noncash_check_1` | Сверка безнала №1 | number | true | both |
| `cash_check_2` | Сверка остатка №2 | number | true | both |
| `credit_check_2` | Проверка кредитов №2 | number | true | both |
| `noncash_check_2` | Сверка безнала №2 | number | true | both |
| `cash_check_3` | Сверка остатка №3 | number | true | both |
| `withdrawal` | Выемка | number | false | both |
| `pko` | ПКО | number | false | both |
| `photo_statement` | Фото ведомости | photo | true | both |
| `photo_acquiring` | Фото эквайринга | photo | true | both |
| `terminal_choice` | Выбор терминала (Т-Банк / Сбербанк / третий) | choice | true | both |
| `photo_terminal` | Фото сверки выбранного терминала | photo | true | both |
| `cash_1c` | Остаток по 1С | number | true | both |
| `delta_comment` | Комментарий при расхождении | text | false | both |

- После «Продолжить смену» B получает тот же список, но без `cash_start` и `photo_x_report`.
- Шаги с `owner_role = both` выполняются отдельно каждой ролью (A и B записываются в RunSteps со своими исполнителями).
- Лишние фото-шаги (витрина, порядок, терминал №1/№2, рабочее место) исключены из чек-листа.
- Терминальные фото делаются один раз на выбранный терминал после явного выбора (`terminal_choice`); до выбора шаг `photo_terminal` недоступен.

**Закрытие (только B / активный closer)**

| code | title | type | required | owner_role |
| --- | --- | --- | --- | --- |
| `start_close` | Начать закрытие смены | check | true | closer |
| `photo_z_report` | Фото Z-отчёта | photo | true | closer |

**Порядок выполнения**
- Дневные шаги идут последовательно; блок конца смены = `withdrawal → pko → photo_statement → photo_acquiring → terminal_choice → photo_terminal → cash_1c → delta_comment`.
- Только после этого closer нажимает «Начать закрытие» → загружает Z-фото → `/summary` закрывает смену.
- Если B не нажал «Продолжить смену», его шаги и напоминания не создаются; opener может завершить смену сам.

### 3.2 Режим двух касс (опционально per shop)
- Магазины со стандартным процессом используют этот же дневной чек-лист: B может быть тем же человеком, что и A, либо вовсе не подключаться (тогда чек-лист B не создаётся, напоминания B не идут).
- Для магазинов вроде `shop_1`, где две кассы ведут разные сотрудники, включаем флаг `Shops.dual_cash_mode = TRUE`. В этом режиме:
  - Дневные шаги размножаются по ролям за счёт `owner_role = both`: и A, и B закрывают одни и те же `step_code` со своими значениями. У opener остаются шаги X-отчёта/кассы старта, у closer их нет.
  - Closer подключается кнопкой «Продолжить смену», видит только свои (или общие) шаги и завершает блок конца смены перед переходом к закрытию.
  - Итоговая сводка (`/summary`, Export) содержит один run, но агрегаты и фото делятся на два блока «Касса A (opener)» / «Касса B (closer)».
- Для магазинов с `dual_cash_mode = TRUE` бот и напоминания считают run незавершённым, пока обязательные шаги обеих ролей не пройдены. Передача роли (`/handover`) разрешена только после закрытия обязательных шагов предыдущего владельца.

Вне MVP (после пилота): автоподтяжка из 1С, веб-панель/дашборды, сложные права.

4. Пользовательские сценарии (flow)

4.1 Opener (открытие)
1. Сотрудник сканирует QR `?start=shop_<id>__open` или жмёт «Начать смену».
2. Бот проверяет whitelist и захватывает Redis-lock `run:{shop_id}:{date}`.
3. Если run отсутствует → создаётся `run(status=opened, opener=caller)`; если run существует без opener → назначается текущий пользователь; иначе бот сообщает «Открытие уже у {username}».
4. FSM ведёт пользователя по дневному списку шагов A: сначала `cash_start` и `photo_x_report`, далее одинаковые шаги с closer (`owner_role = both`).
5. После завершения дневных обязательных шагов run переводится в `in_progress`.
6. Уведомление об opener уходит в общий магазинный чат (менеджер + whitelisted сотрудники).

4.2 Closer (закрытие)
1. Пользователь жмёт «Продолжить смену» (дневные шаги) или QR `?start=shop_<id>__close` для финала.
2. Бот убеждается, что утренний run существует; если нажато «Продолжить смену» — назначает closer и выдаёт тот же дневной список, что и opener, без `cash_start` и `photo_x_report`.
3. После дневных шагов closer выполняет блок конца смены (выемка, ПКО, фото ведомости/эквайринга, выбор терминала, фото терминала, остаток по 1С).
4. Затем closer жмёт «Начать закрытие» → загружает `photo_z_report`. Комментарии по расхождениям собираются на шаге `delta_comment` при |delta| ≥ порога.
5. Команда `/summary` проверяет, что обязательные шаги обеих ролей закрыты, и переводит run `ready_to_close → closed`, формирует summary (opener/closer/дельта + блоки касса A/B) и отправляет в общий магазинный чат. Если closer не назначался, opener может выполнить закрытие сам.

4.3 Менеджер
1. Получает уведомления о старте открытия/закрытия, напоминания, алерты по дельтам и summary/возвраты в общем чате магазина.
2. Команда «Статус смен» показывает прогресс по магазинам, кто назначен opener/closer, текущие статусы и дельты. `/status <shop_id>` даёт детальную карточку, `/summary <shop_id>` — итоговую сводку за день, `/handover ...` — передачу ролей.
3. При возврате на доработку `Runs.status = returned`, бот подсвечивает проблемные шаги и перекидывает run обратно исполнителю, уведомляя общий чат.
4. Команда «Создать смену» остаётся как fallback: менеджер вручную заводит run (если никто не начал), бот рассылает приглашения.

4.4 Передача ролей
1. В summary и экранах менеджера доступны кнопки «Передать открытие» / «Передать закрытие».
2. Менеджер выбирает сотрудника магазина → бот обновляет `opener_user_id`/`closer_user_id`, пишет Audit `handover_open|handover_close`.
3. Новый исполнитель получает уведомление и продолжает с того шага, на котором остановился предыдущий.

4.5 Кросс-замены
1. Пилотные магазины:
   - `shop_1` («Ногмова»): менеджеры `@manager_shop1`, `@bela1502`; сотрудники `@Zuuuuhra99`, `@o_lisaaaa`, `@Asad_lkaev`, `@a1III11`, `@VviVkk`, `@offonar`, `@bela1502`.
   - `shop_2` («Искож»): менеджеры `@manager_shop2`, `@bela1502`; сотрудники `@a1III11`, `@VviVkk`, `@Zuuuuhra99`, `@o_lisaaaa`, `@bela1502`.
2. Чтобы сотрудник временно подменил коллегу в другом магазине, его username добавляется в список `employee_usernames` этого магазина (бот читает список напрямую из Google Sheets). Поле `allow_anyone` не используется для рабочих подмен в пилоте.

4.6 QR / deep-link
1. Формат закреплён: `https://t.me/<BOT_USERNAME>?start=shop_<SHOP_ID>__open` и `...__close`. Эти ссылки печатаются на наклейках и используются в инструкциях.
2. В пилоте не применяем короткие ссылки и HMAC-подписи. В будущем возможна опция `payload + sig`, где `payload = {"shop":"...", "act":"open|close", "exp":<unix>}` → base64, а `sig = HMAC_SHA256(secret, base64(payload)).


5. Правила и проверки
5.1 Ввод
Числа: только цифры и разделитель, автонормализация (запятая/точка), округление 2 знака.


Диапазоны: по шагу (напр., 0…200 000 ₽).


Фото: обязательны `photo_x_report` (только A), `photo_statement`, `photo_acquiring`, `photo_terminal` (после выбора терминала) и `photo_z_report` (только B). Лишние фото (витрина/порядок/терминал №1/№2) не создаются.

Терминалы: шаг `terminal_choice` требует выбора `T-Bank` / `Sberbank` / «Третий терминал» до появления шага `photo_terminal`; без выбора переход к фото и «Далее» блокируется.

Комментарий при расхождении: если |факт − норма| ≥ порога, поле «Комментарий» обязательно.


Запрет закрытия: без хотя бы одного Z-фото и комментария при |delta| ≥ порога run не переводится в `closed`.


5.2 Дельты и нормы
Нормы задаются в шаблоне или вводятся «сверочной» суммой.


Дельта = факт − норма. Порог тревоги на проекте по умолчанию: 300 ₽ (меняемо).


5.3 Статусы и возврат
opened — run создан, но обязательные шаги открытия не завершены.


in_progress — этап открытия закрыт, идёт работа по закрытию.


ready_to_close — все обязательные шаги закрытия заполнены, требуется подтверждение Z-фото/итога.


closed — итог сформирован, summary отправлено менеджеру.


returned — менеджер вернул run на доработку, обязательные «красные» шаги разблокированы.


5.4 Защита от гонок
- На создание run ставим Redis-lock `run:{shop_id}:{date}` (TTL 5–10 с), чтобы гарантировать единственную запись.
- Для назначения ролей используем мягкие локи `run:{shop_id}:{date}:open` и `:close`, чтобы избежать двойного клика.



6. Структура Google Таблицы (листы и поля)
Users
 user_id, tg_id, fio, role(employee|manager), shops(list), is_active, created_at
Shops
 shop_id, name, timezone, manager_usernames, employee_usernames, allow_anyone(TRUE|FALSE), dual_cash_mode(TRUE|FALSE), is_active
Templates
 template_id, name, version, phase(open|continue|close), is_active
TemplateSteps
 template_id, step_order, code, title, type(number|text|check|photo|choice), required(bool), validators_json, norm_rule(optional), owner_role(opener|closer|shared|both)
Runs (инстанс смены)
 run_id, date, shop_id, status(opened|in_progress|ready_to_close|closed|returned), opener_user_id/username/ts, closer_user_id/username/ts, template_open_id, template_close_id, template_phase_map(json), delta_rub, comment, version, created_at, finished_at
RunSteps
 run_id, phase(open|close), step_code, owner_role(opener|closer|shared|both), value_number/value_text/value_check, delta_number, comment, performer_user_id, status(ok|error|pending), updated_at, idempotency_key
Attachments
 run_id, step_code, telegram_file_id, kind(z_report|pos_receipt|other), created_at
Audit
 ts, user_id, action(start_open|start_close|handover_open|handover_close|finish_close|step_update), entity(run|run_step), entity_id, details
Export
 — формируемый лист с плоскими строками для отчёта (фильтры: дата/магазин/статус). Набор колонок (в таком порядке): `export_id, generated_at, period_start, period_end, shop_id, shop_name, run_id, run_date, status, opener_user_id, opener_username, opener_at, closer_user_id, closer_username, closer_at, totals_json, cash_total, noncash_total, delta_total, delta_comment, comment, attachments_summary, audit_link`.
`totals_json` хранит агрегаты по дневным сверкам (касса/безнал/терминалы) для A и B. `cash_total`/`noncash_total` продублированы для фильтров бухгалтерии. `attachments_summary` — список `telegram_file_id` или ссылок на фото Z-отчёта и чеков. `audit_link` указывает на строку в листе Audit с ключевыми событиями run.
Технические приёмы:
Все записи — пакетно; проверка дублей по idempotency_key.


Поле version в Runs (оптимистичная блокировка).


 Ретраи при 429/5xx (экспоненциально).



7. Напоминания
- Таймзона берётся из `Shops.timezone`; напоминания считаются относительно фактического старта роли, а не по плановому времени магазина.
- Роль A (opener): через 15 минут после назначения, затем через 30 минут, затем каждые 45 минут, после 18:00 по времени магазина — каждые 10 минут, пока обязательные дневные шаги A не закрыты.
- Роль B (closer): через 15 минут после «Продолжить смену», затем через 25 минут, затем каждые 30 минут, после 20:00 по времени магазина — каждые 10 минут, пока обязательные дневные шаги B не закрыты. Если closer не назначен, этот поток не стартует.
- Закрытие: после шага `start_close` отправляем напоминания через 10 и 20 минут, затем каждые 30 минут, пока не будет загружен `photo_z_report`.
- Напоминания не ограничиваются по времени суток и сбрасываются только после закрытия всех обязательных шагов соответствующей роли или статуса run (`closed`/`returned`).
- Для каждого run/роли ведётся персистентный state в Redis, чтобы выдерживать интервалы (но не блокировать повторные напоминания).
- При |дельта| ≥ порога — отдельные алерты менеджеру и в общий чат (без повторов до смены состояния).



8. Сообщения/UX (примеры)
Шаг (число):
 «Шаг 3 из 18 — Касса 16:00. Введите сумму, ₽»
 — при ошибке: «Нужно число от 0 до 200 000».
 — при расхождении: «Разница −120 ₽. Напишите коротко причину.»
Шаг (фото):
 «Загрузите фото Z-отчёта. Можно несколькими сообщениями, затем нажмите “Далее”.»
Итог:
 «Смена Магазин-А за 12.11: дневные сверки A/B завершены, терминал: Сбербанк.
 Итоговая дельта: −120 ₽ (комментарий: возврат покупателя).
 Отчёт записан в Таблицу. Сводка опубликована в общем чате магазина и продублирована менеджеру.»
Роли:
 «Выберите действие для Магазин-А: [Открыть смену] / [Начать закрытие]»
 «Открытие уже у @username. Нужна передача — обратитесь к менеджеру.»
 «Закрытие уже у @username. Нужна передача — обратитесь к менеджеру.»
 «Нельзя завершить смену без фото Z-отчёта.»

9. Нефункциональные требования
Надёжность: сохранение не теряется при кратковременных сбоях (ретраи).


Производительность: ответ бота ≤ 1,5 с на обычный шаг, ≤ 5 с на шаги с записью фото/пакетной записью в Таблицу.


Доступность: 99%+ в рабочие часы.


Безопасность: доступ к Таблице — только сервисному аккаунту; токены вне репо; whitelist пользователей.


Логи/аудит: запись ключевых действий в лист Audit.


Concurrency: уникальность `(shop_id,date)` гарантируется Redis-lock `run:{shop_id}:{date}` и отдельными локами по ролям `:open`, `:close` (TTL 5–10 с).



10. Принятие (Acceptance Criteria)
- Единственный run на `(shop_id, date)` (дубли блокируются локами).
- Сотрудник проходит обязательные шаги открытия/закрытия, предоставляет Z-фото, без Excel.
- В Таблице корректно создаются строки в Runs (opener/closer поля), RunSteps (phase), Attachments.
- Итог, алерты и уведомления о передаче ролей приходят менеджеру и в общий магазинный чат.
- Напоминания работают по новым интервалам (A: 15/30/45→10 после 18:00; B: 15/25/30→10 после 20:00; закрытие: 10/20/30) и не прекращаются до завершения обязательных шагов.
- Экспорт «за день/неделю» формируется в лист Export, содержит полный набор полей (opener/closer/дельта/attachments/audit_link) и совпадает с данными шагов.
- При |дельта| ≥ порога комментарий обязателен — без него «Итог» недоступен.



11. Метрики успеха
≥ 90% смен закрываются в боте без ручной переписки.


≤ 1% ошибок ввода (неверный формат/пустые обязательные поля).


−30% времени на закрытие смены vs текущий Excel-процесс.



12. Сроки и этапы
День 1–3: шаблон Таблицы, доступы, прототип бота на одном шаблоне.


Неделя 1: все типы шагов, валидации, дельты, фото, итог.


Неделя 2: напоминания, статусы/возврат, экспорт, аудит, полировка.


Неделя 3: пилот на 2 магазинах (shop_1, shop_2), правки.
 Итого до пилота: ~2,5–3,5 недели.



13. Оценка трудозатрат и бюджета (ориентир)
MVP: ~140–180 ч → 350–540 тыс. ₽ (2 500–3 000 ₽/ч).


Упрощённый старт: ~90–110 ч → 225–330 тыс. ₽.


Поддержка (опц.): 10 ч/мес → 25–30 тыс. ₽.



14. Риски и смягчение
Квоты/лимиты Google: пакетные записи, очереди и ретраи.


Одновременная работа: idempotency_key + version в Runs.


Длинные чек-листы: разделы и прогресс, необязательные шаги можно «Пропустить».


Человеческий фактор: обязательные поля + возврат на доработку.



15. Открытые вопросы (для заказчика)
- Подтвердить плановые времена открытия/закрытия каждого магазина (для расчёта напоминаний −15/−30 мин).
- Нужны ли индивидуальные `delta_threshold` по шагам сверх 300 ₽.
- Нужна ли защита deep-link (короткие ссылки, HMAC) в следующих релизах или текущее решение достаточно.


Порог тревоги по дельте (по умолчанию 300 ₽).
