PRD — «Чек-лист-бот для смен» (Telegram + Google Sheets)
1. Обзор
Цель: заменить Excel-чек-листы на пошаговый бот в Telegram. Сотрудник вводит суммы/галочки/фото, бот проверяет и пишет всё в Google Таблицу. Менеджер получает сводку и может выгружать отчёты за день/неделю.
Ключевая ценность: меньше ошибок и переписок, быстрый итог смены, единое место правды — Google Таблица.

2. Пользователи и роли
Сотрудник магазина — проходит чек-лист, прикладывает фото, комментирует расхождения.


Менеджер — запускает смену, получает сводку/файл, видит историю, может вернуть на доработку.


Бухгалтер/контролёр (опционально) — читает лист «Export».

Пилот охватывает два магазина: `shop_1` («Ногмова») и `shop_2` («Искож»). Оба работают в таймзоне `Europe/Moscow`; один сотрудник может при необходимости завершать и открытие, и закрытие в один день.

2.1 Доступы и whitelist
- Во всех магазинах пилота `allow_anyone = FALSE`. Запустить роль могут только пользователи, чьи `telegram_username` перечислены в `manager_usernames` или `employee_usernames` магазина.
- Кросс-подмены выполняются через списки сотрудников: чтобы временно работать в другом магазине, username добавляют в `employee_usernames` второго магазина. Поле `allow_anyone` зарезервировано под будущие сценарии (тесты, обучение) и не меняет логику пилота.
- Менеджеры (`manager_usernames`) имеют право открывать/закрывать смену, делать handover и возвраты во всех закреплённых магазинах.
- Попытка старта смены пользователем вне whitelist отклоняется текстом «Вы не числитесь в списке сотрудников магазина. Обратитесь к менеджеру для допуска.»



3. Объём работ (MVP)
- Единственный run на `(shop_id, date)`; роли `opener` и `closer` назначаются автоматически по первому нажатию «Начать смену/закрытие».
- Чек-лист разбит на четыре фазы: `open` (подготовка смены), три дневные сверки (`check_1100`, `check_1600`, `check_1900`), `close` (закрытие) и `finance` (финальные фото/сверки).
- Типы шагов: число, текст, галочка, фото. Для фаз `close` и `finance` обязательны фото Z-отчёта и чеков терминалов.
- Проверки: формат числа, диапазоны/пределы, комментарий при |delta| ≥ порога, запрет `Runs.status = closed` без фото.
- Итог смены: сводка в общий магазинный чат (менеджер + исполнители) и запись в Таблицу (Runs/RunSteps/Attachments/Audit/Export) с opener/closer.
- Напоминания приходят перед открытием/закрытием (см. раздел 7) с учётом роли: до назначения роли пингуем всех сотрудников магазина и менеджера, после — только исполнителя и дубль в общий чат.
- История и статусы: `opened → in_progress → ready_to_close → closed`, `returned` для возврата.
- Экспорт в лист «Export» (день/неделя) по кнопке с полями opener/closer/дельта.
- ККМ: по умолчанию одна касса на магазин; все кассовые шаги относятся к ней (без разделения по устройствам).
- Онбординг и локализация: `/start` (без payload) показывает локализованное приветствие и пагинированный список доступных магазинов с двумя CTA («Открыть смену», «Начать закрытие») и кнопкой «Ещё…» для перехода к `/menu`. Все тексты (`start.*`, `menu.*`, ошибки) берутся из `locale/ru/messages.json`; deep-link `?start=shop_<id>__open|__close` минует список и сразу назначает роль.

### 3.1 Фазовая структура чек-листа
**Фаза 1 — `open` (подготовка)**

| code | title | type | required | hint |
| --- | --- | --- | --- | --- |
| `open_checkin` | Начало смены | check | true | Нажмите, когда приступили к работе |
| `open_pos_check` | Проверка работы кассы/терминала | check | true | Убедитесь, что касса, эквайринг и принтер работают |
| `open_cash_start` | Наличные на начало смены | number | true | Введите сумму из 1С / кассы на утро |
| `open_note` | Комментарий | text | false | Проблемы/замечания |

**Фаза 2 — дневные сверки (`check_1100`, `check_1600`, `check_1900`)**

Каждый блок повторяет одинаковые шаги (меняется только плановое значение для норм):

| code | title | type | required | hint |
| --- | --- | --- | --- | --- |
| `chkXXXX_start` | Время факта | check | true | Нажмите, когда начали сверку |
| `chkXXXX_sum` | Остаток по 1С / факт | number | true | Введите сумму факта |
| `chkXXXX_receipts` | Фото чеков реализации | photo | false | Фото отчёта/чеков |
| `chkXXXX_non_cash` | Сумма безнал / терминал | number | false | Введите итог по терминалу |
| `chkXXXX_comment` | Комментарий | text | false | Недостачи/расхождения |

`XXXX` = `1100`, `1600`, `1900`. Все три блока входят в мастер-проход без возможности пропуска.

**Фаза 3 — `close` (закрытие)**

| code | title | type | required | hint |
| --- | --- | --- | --- | --- |
| `close_start` | Начало закрытия | check | true | Нажмите, когда начали закрывать |
| `close_done_1c` | Закрытие смены в 1С | check | true | Подтвердите закрытие смены в 1С |
| `close_form_receipt` | Сформирован чек ККМ о закрытии | check | true | Нажмите после пробития |
| `close_z_sum` | Сумма по Z-отчёту | number | true | Введите сумму |
| `close_cash_end` | Сумма наличных в кассе | number | true | Введите вручную |
| `close_cash_move` | Сдано в инкассацию | number | false | Если сдавали |
| `close_comment` | Комментарий / инциденты | text | false | Недостачи, ошибки |

**Фаза 4 — `finance` (финансовые отчёты)**

| code | title | type | required | hint |
| --- | --- | --- | --- | --- |
| `fin_receipts_photo` | Фото чеков эквайринга | photo | true | Прикрепите фото чеков из терминала |
| `fin_report_dc1c` | Фото ведомости по ДС 1С | photo | true |  |
| `fin_z_photo` | Фото Z-отчёта | photo | true |  |
| `fin_sberbank_sum` | Сверка по терминалу Сбербанк | number | false | Введите сумму из отчёта |
| `fin_tbank_sum` | Сверка по терминалу Т-банк | number | false |  |
| `fin_comment` | Примечание | text | false |  |

### 3.2 Режим двух касс (опционально per shop)
- Магазины со стандартным процессом (например, `shop_2`) продолжают использовать единственный набор шагов. `opener` открывает смену, closer подключается перед закрытием и проходит фазы `close`/`finance`.
- Для магазинов вроде `shop_1`, где две кассы ведут разные сотрудники, включаем флаг `Shops.dual_cash_mode = TRUE`. В этом режиме:
  - Шаги фаз `open`, дневных сверок и `finance` размножаются на блоки с признаком `owner_role = opener|closer`. Код шага дополняем суффиксом (`cash_float_open_opener`, `cash_float_open_closer` и т.д.).
  - `opener` (касса А) проходит свои шаги + фото (включая X-отчёт), но не видит Z-отчёт и кнопки закрытия. Все дневные сверки после 11:00 для кассы А остаются его ответственностью.
  - `closer` (касса B) подключается кнопкой «Продолжить смену», видит только шаги с `owner_role = closer`, выполняет свои сверки, фото и обязателен к загрузке `fin_z_photo` перед закрытием.
  - Итоговая сводка (`/summary`, Export) содержит один run, но агрегаты и фото делятся на два блока «Касса A (opener)» / «Касса B (closer)».
- Для магазинов с `dual_cash_mode = TRUE` бот и напоминания считают run незавершённым, пока обязательные шаги обеих ролей не пройдены. Передача роли (`/handover`) разрешена только после закрытия обязательных шагов предыдущего владельца.

Вне MVP (после пилота): автоподтяжка из 1С, веб-панель/дашборды, сложные права.

4. Пользовательские сценарии (flow)

4.1 Opener (открытие)
1. Сотрудник сканирует QR `?start=shop_<id>__open` или жмёт «Начать смену».
2. Бот проверяет whitelist и захватывает Redis-lock `run:{shop_id}:{date}`.
3. Если run отсутствует → создаётся `run(status=opened, opener=caller)`; если run существует без opener → назначается текущий пользователь; иначе бот сообщает «Открытие уже у {username}».
4. FSM ведёт пользователя по фазе `open`, далее автоматически переводит в блоки дневных сверок `check_1100/1600/1900` без возможности перепрыгнуть.
5. После завершения `open` run переводится в `in_progress`.
6. Уведомление об opener уходит в общий магазинный чат (менеджер + whitelisted сотрудники).

4.2 Closer (закрытие)
1. Пользователь жмёт «Начать закрытие» или QR `?start=shop_<id>__close`.
2. Бот убеждается, что утренний run существует и обязательные шаги открытия завершены.
3. Захватываем `run:{shop_id}:{date}:close`. Если `closer_user_id` свободен → назначаем текущего пользователя, иначе показываем сообщение о занятости роли. Для магазинов с `dual_cash_mode = TRUE` пользователь может подключиться через CTA «Продолжить смену» (без закрытия), увидеть только «свои» шаги и выполнять дневные сверки параллельно с opener-ом.
4. Пользователь проходит фазы `close` и `finance`: касса 19:00, терминалы, обязательные фото Z-отчёта и чеков. Комментарий обязателен при |delta| ≥ порога. В режиме двух касс closer также видит собственные шаги дневных сверок (с признаком `owner_role = closer`) и отвечает за фото/ПКО по своей кассе.
5. Кнопка «Итог» → проверяем, что все обязательные шаги `status = ok` у обеих ролей, присутствует Z-фото (только closer). Run переходит `ready_to_close → closed`, формируется summary (opener/closer/дельта + блоки касса A/B) и отправляется в общий магазинный чат.

4.3 Менеджер
1. Получает уведомления о старте открытия/закрытия, напоминания, алерты по дельтам и summary/возвраты в общем чате магазина.
2. Команда «Статус смен» показывает прогресс по магазинам, кто назначен opener/closer, текущие статусы и дельты. `/status <shop_id>` даёт детальную карточку, `/summary <shop_id>` — итоговую сводку за день, `/handover ...` — передачу ролей.
3. При возврате на доработку `Runs.status = returned`, бот подсвечивает проблемные шаги и перекидывает run обратно исполнителю, уведомляя общий чат.
4. Команда «Создать смену» остаётся как fallback: менеджер вручную заводит run (если никто не начал), бот рассылает приглашения.

4.4 Передача ролей
1. В summary и экранах менеджера доступны кнопки «Передать открытие» / «Передать закрытие».
2. Менеджер выбирает сотрудника магазина → бот обновляет `opener_user_id`/`closer_user_id`, пишет Audit `handover_open|handover_close`.
3. Новый исполнитель получает уведомление и продолжает с того шага, на котором остановился предыдущий.

4.5 Кросс-замены
1. Пилотные магазины:
   - `shop_1` («Ногмова»): менеджер `@manager_shop1`, сотрудники `@Zuuuuhra99`, `@o_lisaaaa`, `@Asad_lkaev`, `@a1III11`, `@VviVkk`, `@offonar`.
   - `shop_2` («Искож»): менеджер `@manager_shop2`, сотрудники `@a1III11`, `@VviVkk`, `@Zuuuuhra99`, `@o_lisaaaa`.
2. Чтобы сотрудник временно подменил коллегу в другом магазине, его username добавляется в список `employee_usernames` этого магазина (бот читает список напрямую из Google Sheets). Поле `allow_anyone` не используется для рабочих подмен в пилоте.

4.6 QR / deep-link
1. Формат закреплён: `https://t.me/<BOT_USERNAME>?start=shop_<SHOP_ID>__open` и `...__close`. Эти ссылки печатаются на наклейках и используются в инструкциях.
2. В пилоте не применяем короткие ссылки и HMAC-подписи. В будущем возможна опция `payload + sig`, где `payload = {"shop":"...", "act":"open|close", "exp":<unix>}` → base64, а `sig = HMAC_SHA256(secret, base64(payload)).


5. Правила и проверки
5.1 Ввод
Числа: только цифры и разделитель, автонормализация (запятая/точка), округление 2 знака.


Диапазоны: по шагу (напр., 0…200 000 ₽).


Фото: требуются для Z-отчёта/терминалов (проверка наличия).


Комментарий при расхождении: если |факт − норма| ≥ порога, поле «Комментарий» обязательно.


Запрет закрытия: без хотя бы одного Z-фото и комментария при |delta| ≥ порога run не переводится в `closed`.


5.2 Дельты и нормы
Нормы задаются в шаблоне или вводятся «сверочной» суммой.


Дельта = факт − норма. Порог тревоги на проекте по умолчанию: 300 ₽ (меняемо).


5.3 Статусы и возврат
opened — run создан, но обязательные шаги открытия не завершены.


in_progress — этап открытия закрыт, идёт работа по закрытию.


ready_to_close — все обязательные шаги закрытия заполнены, требуется подтверждение Z-фото/итога.


closed — итог сформирован, summary отправлено менеджеру.


returned — менеджер вернул run на доработку, обязательные «красные» шаги разблокированы.


5.4 Защита от гонок
- На создание run ставим Redis-lock `run:{shop_id}:{date}` (TTL 5–10 с), чтобы гарантировать единственную запись.
- Для назначения ролей используем мягкие локи `run:{shop_id}:{date}:open` и `:close`, чтобы избежать двойного клика.



6. Структура Google Таблицы (листы и поля)
Users
 user_id, tg_id, fio, role(employee|manager), shops(list), is_active, created_at
Shops
 shop_id, name, timezone, manager_usernames, employee_usernames, allow_anyone(TRUE|FALSE), dual_cash_mode(TRUE|FALSE), is_active
Templates
 template_id, name, version, phase(open|close), is_active
TemplateSteps
 template_id, step_order, code, title, type(number|text|check|photo), required(bool), validators_json, norm_rule(optional), owner_role(opener|closer|shared)
Runs (инстанс смены)
 run_id, date, shop_id, status(opened|in_progress|ready_to_close|closed|returned), opener_user_id/username/ts, closer_user_id/username/ts, template_open_id, template_close_id, template_phase_map(json), delta_rub, comment, version, created_at, finished_at
RunSteps
 run_id, phase(open|close), step_code, owner_role(opener|closer|shared), value_number/value_text/value_check, delta_number, comment, performer_user_id, status(ok|error|pending), updated_at, idempotency_key
Attachments
 run_id, step_code, telegram_file_id, kind(z_report|pos_receipt|other), created_at
Audit
 ts, user_id, action(start_open|start_close|handover_open|handover_close|finish_close|step_update), entity(run|run_step), entity_id, details
Export
 — формируемый лист с плоскими строками для отчёта (фильтры: дата/магазин/статус). Набор колонок (в таком порядке): `export_id, generated_at, period_start, period_end, shop_id, shop_name, run_id, run_date, status, opener_user_id, opener_username, opener_at, closer_user_id, closer_username, closer_at, totals_json, cash_total, noncash_total, delta_total, delta_comment, comment, attachments_summary, audit_link`.
`totals_json` хранит агрегаты по сверкам (касса 11/16/19, эквайринг). `cash_total`/`noncash_total` продублированы для фильтров бухгалтерии. `attachments_summary` — список `telegram_file_id` или ссылок на фото Z-отчёта и чеков. `audit_link` указывает на строку в листе Audit с ключевыми событиями run.
Технические приёмы:
Все записи — пакетно; проверка дублей по idempotency_key.


Поле version в Runs (оптимистичная блокировка).


Ретраи при 429/5xx (экспоненциально).



7. Напоминания
- Все магазины работают в таймзоне `Europe/Moscow`. Поле `Shops.reminder_slots` в пилоте не заполняется (NULL), кроме дополнительных слотов, описанных ниже.
- Напоминание «open» срабатывает за 15 минут до планового открытия магазина. Напоминание «close» — за 30 минут до планового закрытия. Плановые времена задаются в конфигурации магазина/окружении.
- Для магазинов с одной кассой расписание ограничивается open/close-слотами. Для магазинов с `dual_cash_mode = TRUE` добавляем дневные слоты (12:00, 13:00, 13:30, 15:00, 16:00, 16:30, 17:30) и фильтруем аудиторию:
  - до 11:00 уведомления (open) идут только opener-у;
  - после 11:00, пока не назначен closer, рассылаем всем `employee_usernames` магазина;
  - после назначения closer дневные слоты отправляются только исполнителю нужной роли (`owner_role` шага) и дублируются в общий чат.
- До назначения роли уведомления отправляются всем из `employee_usernames` + `manager_usernames`. После назначения — только текущему исполнителю и общий чат, но для режима двух касс действуют уточнения выше.
- Для каждого run/слота ведётся флаг `reminder_state`, чтобы исключить дубли до изменения статуса (`returned`/`closed`).
- При |дельта| ≥ порога — уведомляем менеджера магазина и общий чат (без повторов до смены состояния).



8. Сообщения/UX (примеры)
Шаг (число):
 «Шаг 3 из 18 — Касса 16:00. Введите сумму, ₽»
 — при ошибке: «Нужно число от 0 до 200 000».
 — при расхождении: «Разница −120 ₽. Напишите коротко причину.»
Шаг (фото):
 «Загрузите фото Z-отчёта. Можно несколькими сообщениями, затем нажмите “Далее”.»
Итог:
 «Смена Магазин-А за 12.11: касса 11:00/16:00/19:00, терминалы: Сбер/Т-банк.
 Итоговая дельта: −120 ₽ (комментарий: возврат покупателя).
 Отчёт записан в Таблицу. Сводка опубликована в общем чате магазина и продублирована менеджеру.»
Роли:
 «Выберите действие для Магазин-А: [Открыть смену] / [Начать закрытие]»
 «Открытие уже у @username. Нужна передача — обратитесь к менеджеру.»
 «Закрытие уже у @username. Нужна передача — обратитесь к менеджеру.»
 «Нельзя завершить смену без фото Z-отчёта.»

9. Нефункциональные требования
Надёжность: сохранение не теряется при кратковременных сбоях (ретраи).


Производительность: ответ бота ≤ 1,5 с на обычный шаг, ≤ 5 с на шаги с записью фото/пакетной записью в Таблицу.


Доступность: 99%+ в рабочие часы.


Безопасность: доступ к Таблице — только сервисному аккаунту; токены вне репо; whitelist пользователей.


Логи/аудит: запись ключевых действий в лист Audit.


Concurrency: уникальность `(shop_id,date)` гарантируется Redis-lock `run:{shop_id}:{date}` и отдельными локами по ролям `:open`, `:close` (TTL 5–10 с).



10. Принятие (Acceptance Criteria)
- Единственный run на `(shop_id, date)` (дубли блокируются локами).
- Сотрудник проходит обязательные шаги открытия/закрытия, предоставляет Z-фото, без Excel.
- В Таблице корректно создаются строки в Runs (opener/closer поля), RunSteps (phase), Attachments.
- Итог, алерты и уведомления о передаче ролей приходят менеджеру и в общий магазинный чат.
- Напоминания отправляются в окна открытия/закрытия (−15/−30 мин) с учётом роли и дубля в чат.
- Экспорт «за день/неделю» формируется в лист Export, содержит полный набор полей (opener/closer/дельта/attachments/audit_link) и совпадает с данными шагов.
- При |дельта| ≥ порога комментарий обязателен — без него «Итог» недоступен.



11. Метрики успеха
≥ 90% смен закрываются в боте без ручной переписки.


≤ 1% ошибок ввода (неверный формат/пустые обязательные поля).


−30% времени на закрытие смены vs текущий Excel-процесс.



12. Сроки и этапы
День 1–3: шаблон Таблицы, доступы, прототип бота на одном шаблоне.


Неделя 1: все типы шагов, валидации, дельты, фото, итог.


Неделя 2: напоминания, статусы/возврат, экспорт, аудит, полировка.


Неделя 3: пилот на 2 магазинах (shop_1, shop_2), правки.
 Итого до пилота: ~2,5–3,5 недели.



13. Оценка трудозатрат и бюджета (ориентир)
MVP: ~140–180 ч → 350–540 тыс. ₽ (2 500–3 000 ₽/ч).


Упрощённый старт: ~90–110 ч → 225–330 тыс. ₽.


Поддержка (опц.): 10 ч/мес → 25–30 тыс. ₽.



14. Риски и смягчение
Квоты/лимиты Google: пакетные записи, очереди и ретраи.


Одновременная работа: idempotency_key + version в Runs.


Длинные чек-листы: разделы и прогресс, необязательные шаги можно «Пропустить».


Человеческий фактор: обязательные поля + возврат на доработку.



15. Открытые вопросы (для заказчика)
- Подтвердить плановые времена открытия/закрытия каждого магазина (для расчёта напоминаний −15/−30 мин).
- Нужны ли индивидуальные `delta_threshold` по шагам сверх 300 ₽.
- Нужна ли защита deep-link (короткие ссылки, HMAC) в следующих релизах или текущее решение достаточно.


Порог тревоги по дельте (по умолчанию 300 ₽).
