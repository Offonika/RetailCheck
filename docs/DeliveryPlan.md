# План доставки MVP

Документ фиксирует последовательность работ перед стартом разработки и в ходе спринтов. Он нужен, чтобы команда синхронизировала ожидания по срокам, зависимостям и артефактам.

## 1. Предпосылки (Done перед кодом)
1. Утверждены `docs/Architecture.md`, `docs/DataModel.md`, `docs/BotFlows.md`, `agents.md`.
2. Получен доступ к Google Таблице + сервисному аккаунту.
3. Определён технический стек (Python версия, библиотека бота, план деплоя Docker/systemd).
4. Согласованы магазины и пользователи пилота, заполнены листы `Users`, `Shops`.

## 2. Фазы MVP

| Фаза | Срок | Цель | Ключевые задачи | Артефакт DoD |
| --- | --- | --- | --- | --- |
| F0. Setup | День 1–2 | Готовность окружения | Поднять репозиторий, CI, базовый Dockerfile, подключить Secrets | CI green, дев-среда описана в README |
| F1. Data & Templates | День 2–4 | Считывать справочники и шаблоны | Импорт листов Users/Shops/Templates, CLI для загрузки шаблонов | CLI проверка, unit-тесты валидаций |
| F2. Employee Flow | Неделя 1 | Пройти чек-лист end-to-end | FSM шагов, валидации, запись RunSteps, Attachments, итог | Демонстрация сценария сотрудника на тестовом боте |
| F3. Manager Flow | Неделя 1–2 | Управление сменами | Команды создания, статусы, возврат, summary менеджеру | Тест: менеджер создаёт смену, сотрудник закрывает, менеджер возвращает |
| F4. Reminders & Alerts | Неделя 2 | SLA по времени/дельтам | Scheduler, напоминания, уведомления о дельтах | Интеграционный тест с mock-часами |
| F5. Export & Audit | Неделя 2 | Отчётность и журнал | Генерация листа Export, записи в Audit | Экспорт за день совпадает с Runs/RunSteps, Audit заполняется |
| F6. Hardening | Неделя 3 | Подготовка пилота | Логи, ретраи, хардкод порогов → конфиги, load-тест 100 шагов | Чек-лист готовности подписан |

## Этапы F0 → F1
- **F0:** один run на день; назначение opener/closer; базовые шаги; экспорт в Sheets; сообщения об уже занятой роли.
- **F1:** передача ролей из Telegram; валидация Z-фото; напоминания до/после назначения роли; QR-deep-link.
- **Риски:** гонки при старте — см. Redis-lock; отсутствие username — работаем по user_id.

## 3. Дорожная карта задач
- **Environment**
  - Создать `.env.example` (bot token, sheet id, redis url).
  - Скрипты `make dev` / `make test` / `make lint`.
- **Интеграции**
  - Обёртка Google Sheets с batch API, `idempotency_key`.
  - Клиент Telegram (webhook handler, middleware логирования).
- **Доменные сервисы**
  - `RunsService`: создание/обновление Runs, статус-машина, версии.
  - `StepsService`: получение шаблонов, применение validator chain.
  - `ReminderService`: выборка pending Runs, отправка сообщений.
  - `ExportService`: агрегация RunSteps → Export.
- **UX/Copy**
  - Согласовать финальные тексты сообщений (ошибки, подсказки, summary).
  - Локализация (ru, возможно en) через .json.
- **QA**
  - Набор unit-тестов на валидаторы и сервисы.
  - Интеграционный тест `tests/e2e/test_shift_flow.py` с mock Telegram.
  - Чек-лист ручного теста для пилота (Google Docs/Notion).

## 4. Риски и смягчение
| Риск | Влияние | Смягчение |
| --- | --- | --- |
| Лимиты Google Sheets (429) | Потеря данных шага | Batch + retry + idempotency |
| Неполные шаблоны шагов | Блокирует FSM | Вовлечь менеджера в ревью `docs/BotFlows.md`, freeze за 3 дня до разработки |
| Отсутствие Redis | Усложнение FSM, напоминаний | Подготовить fallback на SQLite/файловое хранилище + cron |
| Ручные правки Таблицы | Инконсистентность | Audit + минимизировать ручные входы, проверка целостности при старте |

## 5. Acceptance для выхода в пилот
1. Сотрудник проходит смену и прикладывает фото без ошибок.
2. Напоминания приходят в назначенные слоты при незакрытых шагах.
3. Менеджер получает summary, может вернуть и получить экспорт.
4. Лист `Export` совпадает с RunSteps, Audit фиксирует ключевые события.
5. Документация (OnePage, PRD, agents, Architecture, DataModel, BotFlows, DeliveryPlan) актуальна и хранится в репозитории.

## 6. План внедрения режима двух касс (`dual_cash_mode`)
Этап актуален для магазинов с двумя кассами (shop_1). Реализуем последовательно, чтобы сохранить стабильность pilota.

1. **Подготовка (D0).**
   - Зафиксировать пилотный магазин, даты включения и ответственных.
   - Сделать копию текущей Google Sheet (бэкап) и описать сценарий отката (снятие флага + откат шаблонов).
   - Уведомить менеджеров/сотрудников о новой схеме, подготовить FAQ.
2. **Обновление таблиц (D1).**
   - Добавить поля `dual_cash_mode` и `reminder_slots` в `Shops`, `owner_role` в `TemplateSteps`.
   - Импортировать версии шаблонов с шагами касса A/B, убедиться, что импортер работает на копии таблицы.
3. **Миграции и код (D2–D4).**
   - Расширить `RunSteps`/`Attachments`/`Export` полями `owner_role`, `performer_user_id`, `totals_json.opener/closer`.
   - Реализовать CTA «Продолжить смену», фильтрацию шагов по ролям, обновлённое `/summary`, логику новых напоминаний и delta-alerts.
4. **QA и пилот (D5).**
   - Обновить unit/e2e-тесты (два сотрудника → одна смена), подготовить чек-лист.
   - Прогнать пилот на shop_1, зафиксировать метрики (дельты, количество напоминаний).
5. **Релиз и последующий мониторинг.**
   - Включить `dual_cash_mode` в рабочей таблице для shop_1 и наблюдать 1–2 смены.
   - При успешном результате расширить на остальные магазины или вернуть режим по сценарию отката.
