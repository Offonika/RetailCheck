# Agents (RetailCheck Checklist Bot)

Документ описывает ключевых агентов (людей и сервисов), которые обеспечивают работу MVP «Чек-лист-бота для смен» из `docs/OnePage.md` и `docs/PRD.md`.

| Агент | Тип | Цель | Ключевые артефакты |
| --- | --- | --- | --- |
| Сотрудник магазина | Пользователь | Проходит чек-лист, фиксирует фактические данные и фото | Runs, RunSteps, Attachments |
| Менеджер магазина | Пользователь | Создаёт смены, контролирует дельты, принимает итог/возвращает | Runs, Export, Audit |
| Telegram чек-лист-бот | Сервис | Ведёт диалог, валидирует ввод, синхронизирует данные | Telegram chat, Google Sheets API |
| Google Sheets Sync | Интеграция | Поддерживает «единое место правды» и идемпотентность | Sheets: Users, Shops, Templates… |
| Напоминания и алерты | Фоновый сервис | Обеспечивает SLA по времени и контролю расхождений | Телеграм-уведомления, Runs |
| Экспорт и аудит | Сервис/скрипт | Готовит отчётность и следит за изменениями | Export, Audit |

## Сотрудник магазина
- **Цель.** Закрыть смену без Excel, пройти все обязательные шаги и предоставить доказательства (фото Z-отчёта, суммы, комментарии).
- **Входы.** Приглашение «Начать смену», шаблон чек-листа (обычно «Вечерняя смена» с контрольными точками 11:00/16:00/19:00/закрытие).
- **Выходы.** Заполненные шаги `RunSteps`, вложения `Attachments`, комментарии по расхождениям, финальное подтверждение «Итог».
- **Ключевые действия.**
  1. По шагам вводит числа/текст/чекбоксы/фото; при необходимости двигается «Назад» или «Пропустить» необязательный шаг.
  2. При дельте ≥ 300 ₽ добавляет комментарий, иначе бот не разрешит закрыть смену.
  3. После шага «Итог» отправляет итоговую карточку менеджеру и меняет статус Runs на `done`.
- **Риски/ошибки.** Неверный формат чисел (разделитель, диапазон 0…200 000 ₽), отсутствие обязательного фото или комментария, незавершённые шаги → статус `in_progress` и напоминания.
- **Метрики успеха.** ≥90% смен закрыты без ручной переписки; ≤1% ошибок ввода.

## Менеджер магазина
- **Цель.** Инициализировать смены по магазинам, отследить дельты, принять итоги и запускать экспорт.
- **Входы.** Команда «Создать смену» (или автосоздание по расписанию), напоминания о просроченных шагах, алерты о превышении порога.
- **Выходы.** Сводки в Telegram, статусы Runs (`in_progress`, `done`, `returned`), записи в `Audit`, выгрузка листа `Export`.
- **Ключевые действия.**
  1. Назначает чек-лист нужному магазину, убеждается, что сотрудник назначен в белом списке.
  2. Следит за напоминаниями (11:00/16:00/19:00), при необходимости «Возвращает на доработку» (Run → `returned`).
  3. Получает итоговую карточку, запускает «Экспорт за день/неделю» и контролирует дельты > 300 ₽.
- **Риски/ошибки.** Несвоевременное создание смен → пропущенные напоминания; игнорирование алертов → накопление дельт; ручные правки в Таблице без Audit.
- **Метрики.** Доля смен «returned», количество напоминаний до закрытия, время реакции на тревоги.

## Telegram чек-лист-бот
- **Цель.** Одна сервисная точка входа на Ubuntu-сервере (Docker/systemd) c HTTPS-прокси через Nginx/Apache и webhook `https://bot.offonika.ru/checklist/webhook`.
- **Функции.**
  1. Диалоговый движок: «Шаг X из N», подсказки и UX-сообщения для чисел/фото/чеков, поддержка кнопок «Назад/Далее/Пропустить/Итог».
  2. Валидация: формат чисел, диапазоны, обязательность, проверка комментариев при дельте, требование фото для Z-отчётов и терминалов.
  3. Расчёт дельт и подсветка расхождений (|факт−норма|) сразу в чате.
  4. Запись в Google Sheets пакетными батчами с ретраями и `idempotency_key`; ведёт поле `version` в Runs.
  5. Формирование итогового сообщения менеджеру и обновление статусов `RunSteps`.
- **Интерфейсы.** Telegram Bot API, Google Sheets API. Хранит только `telegram_file_id` для фото, физически файлы не дублирует.
- **НФТ.** Ответ ≤1.5 с для стандартного шага (≤5 с для фото), доступность 99%+, логирование ключевых действий в лист Audit.

## Google Sheets Sync
- **Назначение.** «Единый источник правды» вместо БД. Работает с листами: `Users`, `Shops`, `Templates`, `TemplateSteps`, `Runs`, `RunSteps`, `Attachments`, `Audit`, `Export`.
- **Функции.**
  1. Поддерживает актуальные справочники пользователей/магазинов/шаблонов с флагами активности.
  2. Сохраняет Runs и RunSteps пакетно, предотвращая дубли через `idempotency_key`.
  3. Обновляет `version` в Runs, чтобы избежать перезаписи параллельных апдейтов.
  4. Делегирует доступ сервисному аккаунту уровня «Редактор»; применяет ретраи при 429/5xx.
- **Контроль качества.** После каждой смены проверяются согласованность Runs ↔ RunSteps ↔ Attachments и соответствие листа Export данным шагов.

## Напоминания и алерты
- **Цель.** Поддерживать ритм выполнения чек-листа и оперативно эскалировать расхождения.
- **Сценарии.**
  1. По расписанию 11:00 / 16:00 / 19:00 проверяется наличие Runs со статусом `in_progress` и незакрытых обязательных шагов → мягкое напоминание сотрудникам магазина.
  2. При |дельта| ≥ порога (по умолчанию 300 ₽, настраивается) отправляется уведомление менеджеру.
- **Требования.** Никаких дубликатов уведомлений для одного и того же условия; «возврат на доработку» сбрасывает таймеры; SLA доставки в рабочие часы.

## Экспорт и аудит
- **Цель.** Дать менеджерам и бухгалтерии сводные отчёты и прозрачный журнал действий.
- **Экспорт.**
  - Кнопки «Экспорт за день/неделю» формируют плоские строки в листе `Export` с фильтрами по дате, магазину, статусу.
  - Экспорт должен совпадать с исходными Runs/RunSteps; ошибки считаются блокирующими для acceptance.
- **Аудит.**
  - В лист `Audit` пишутся `ts`, `user_id`, `action`, `entity`, `entity_id`, `details` для всех ключевых событий (создание/закрытие/возврат смен, изменения шагов).
  - Журнал служит для расследований и контроля доступа; токены и чувствительные данные хранятся вне репозитория.

## Открытые вопросы (для уточнения агентами)
1. Финализировать список шагов и обязательность для первого шаблона.
2. Уточнить нормы и пороги дельт по каждому шагу (где строгий ноль, где допускается разброс).
3. Подтвердить список магазинов/менеджеров и Telegram-ID для белого списка.
4. Зафиксировать расписание напоминаний, если нужно отклониться от 11:00 / 16:00 / 19:00.
