## Working agreements
- Перед любыми правками кода проверяй, затронули ли они Python/бот-сервисы; если да — планируй запуск `pytest` из `make test` перед сдачей работы.
- Запуск `make lint` обязателен перед открытием PR или финальным отчётом, если менялись исходники.
- Новые внешние зависимости (Python, системные пакеты) добавляй только после явного подтверждения заказчика.
- Заметил несоответствие между документацией и кодом — сначала обнови `docs/` (PRD/BotFlows/Tasks), потом реализуй изменения.

# Agents (RetailCheck Checklist Bot)

Документ описывает ключевых агентов (людей и сервисов), которые обеспечивают работу MVP «Чек-лист-бота для смен» из `docs/OnePage.md` и `docs/PRD.md`.

| Агент | Тип | Цель | Ключевые артефакты |
| --- | --- | --- | --- |
| Сотрудник магазина | Пользователь | Проходит чек-лист (как opener или closer), фиксирует фактические данные и фото | Runs, RunSteps, Attachments |
| Менеджер магазина | Пользователь | Создаёт смены, контролирует дельты, принимает итог/возвращает | Runs, Export, Audit |
| Telegram чек-лист-бот | Сервис | Ведёт диалог, валидирует ввод, синхронизирует данные | Telegram chat, Google Sheets API |
| Google Sheets Sync | Интеграция | Поддерживает «единое место правды» и идемпотентность | Sheets: Users, Shops, Templates… |
| Напоминания и алерты | Фоновый сервис | Обеспечивает SLA по времени и контролю расхождений | Телеграм-уведомления, Runs |
| Экспорт и аудит | Сервис/скрипт | Готовит отчётность и следит за изменениями | Export, Audit |

## Сотрудник магазина
- **Цель.** Закрыть ежедневную смену без Excel, выступая как opener (утро) или closer (закрытие), пройти обязательные шаги и предоставить доказательства (фото Z-отчёта, суммы, комментарии).
- **Входы.** Deep-link/QR `?start=shop_<id>__open|__close`, приглашения «Начать смену/закрытие», шаблоны «Открытие» или «Закрытие».
- **Выходы.** Заполненные шаги `RunSteps` с phase=open/close, вложения `Attachments`, комментарии по расхождениям, итог `Run.status = closed`.
- **Ключевые действия.**
  1. Первый, кто нажал «Начать смену», автоматически закрепляет роль opener; аналогично для closer через «Начать закрытие».
  2. Вводит числа/текст/фото; при |дельта| ≥ 300 ₽ добавляет комментарий, иначе бот блокирует переход.
  3. Загружает обязательное Z-фото (для закрытия), завершает шаг «Итог» и отправляет summary менеджеру.
- **Риски/ошибки.** Двойной клик без локов, неверный формат чисел, отсутствие Z-фото или комментария → run остаётся `in_progress`, приходят напоминания по роли.
- **Метрики успеха.** ≥90% смен закрываются в боте без ручной переписки; ≤1% ошибок ввода по числам/фото.

## Менеджер магазина
- **Цель.** Контролировать единственный ежедневный run на магазин, отслеживать дельты, передавать роли при необходимости и запускать экспорт.
- **Входы.** Уведомления об автосоздании run (opener стартовал), напоминания о просроченных шагах, алерты о превышении порога, запросы на передачу роли.
- **Выходы.** Сводки в Telegram, статусы Runs (`opened`, `in_progress`, `ready_to_close`, `closed`, `returned`), записи в `Audit`, строки в `Export`.
- **Ключевые действия.**
  1. Подтверждает белые списки пользователей/магазинов и при необходимости вручную создаёт run с блокировкой `run:{shop_id}:{date}` (fallback).
  2. Использует кнопки «Передать открытие/закрытие» → выбирает сотрудника → фиксирует событие в Audit.
  3. Контролирует Z-фото и дельты > 300 ₽, возвращает run (`status = returned`) на доработку, запускает «Экспорт за день/неделю`.
- **Согласованные whitelist-правила.**
  - Магазин 1: `@Zuuuuhra99`, `@o_lisaaaa`, универсальный менеджер/сотрудник `@bela1502` (user_id 755543399) + резерв `@Asad_lkaev`; могут подменять смены магазина 2.
  - Магазин 2: `@a1III11`, `@VviVkk`, `@offonar`, `@bela1502`; при необходимости закрывают смены магазина 1.
- **Риски/ошибки.** Игнорирование алертов по дельте, ручные правки в Таблице без Audit, несинхронная передача роли → run зависает в `opened`/`in_progress`.
- **Метрики.** Доля run, которые пришлось возвращать, время реакции на тревоги, количество автонапоминаний до закрытия.

## Telegram чек-лист-бот
- **Цель.** Сервисная точка входа с deep-link поддержкой (`?start=shop_<id>__open|__close`) на Ubuntu-сервере (Docker/systemd) и HTTPS-прокси `https://bot.offonika.ru/checklist/webhook`.
- **Функции.**
  1. Назначение ролей opener/closer по первому нажатию «Начать смену/закрытие», проверка белого списка магазина.
  2. Диалоговый движок по фазам open/close: подсказки, кнопки «Назад/Далее/Пропустить/Итог».
  3. Валидации чисел/фото/комментариев, обязательное Z-фото перед переводом run в `ready_to_close`/`closed`.
  4. Расчёт дельт, подсветка расхождений, требование комментария при |delta| ≥ порога.
  5. По каждой фазе берёт `template_id` из `Runs.template_phase_map` и загружает релевантные `TemplateSteps` (отдельно `open`, `check_1100/1600/1900`, `close`, `finance`).
  6. Запись Runs/RunSteps batch-запросами c `idempotency_key`, ведение `version`, логирование Audit (`start_open`, `handover_close`, `finish_close` и т.д.).
- **Интерфейсы.** Telegram Bot API, Google Sheets API. Хранит `telegram_file_id`, файлы не дублирует.
- **НФТ.** Ответ ≤1.5 с на обычный шаг (≤5 с для фото), доступность 99%+, Redis-локи на `run:{shop_id}:{date}` и по ролям.

## Google Sheets Sync
- **Назначение.** «Единый источник правды». Работает с листами: `Users`, `Shops`, `Templates(open/close)`, `TemplateSteps`, `Runs` (opener/closer поля, уникальность `(shop_id,date)`), `RunSteps` (phase=open/close), `Attachments`, `Audit`, `Export`.
- **Функции.**
  1. Поддерживает справочники пользователей/магазинов и признак `allow_anyone` (в пилоте для рабочих магазинов всегда `FALSE`, используется лишь для тестовых записей).
  2. Сохраняет Runs/RunSteps batch-запросами, гарантирует `idempotency_key` и `version`.
  3. Валидирует наличие Z-фото перед установкой `Runs.status = closed`.
  4. Делегирует доступ сервисному аккаунту уровня «Редактор», ретраи при 429/5xx.
- **Контроль качества.** После каждой смены сверяются Runs ↔ RunSteps ↔ Attachments, экспорт содержит opener/closer и итоговую дельту.

## Напоминания и алерты
- **Цель.** Поддерживать ритм выполнения чек-листа и оперативно эскалировать расхождения с учётом ролей.
- **Сценарии.**
- **Слоты.** Два дефолтных напоминания для всех магазинов пилота: `open_reminder = плановое_открытие − 15 мин`, `close_reminder = плановое_закрытие − 30 мин`. Таймзона берётся из `Shops.timezone`; поле `reminder_slots` пустое (override появится позже).
- **Кому слать.** До назначения роли — всем из `employee_usernames` + менеджеру, после назначения — только исполнителю роли + в общий магазинный чат.
- **Дельта-алерты.** При |дельта| ≥ порога (по умолчанию 300 ₽) отправляется уведомление менеджеру; повторов нет до сброса условия.
- **Требования.** Никаких дублей для одного условия, «возврат на доработку» сбрасывает таймеры и снова активирует напоминания на роль; SLA доставки в рабочие часы.

## Экспорт и аудит
- **Цель.** Дать менеджерам и бухгалтерии отчёты и прозрачный журнал действий (включая смену ролей).
- **Экспорт.**
  - Кнопки «Экспорт за день/неделю» формируют строки в `Export` со столбцами opener/closer, итоговая дельта, комментарий, статус (`closed`/`returned`).
  - Данные должны совпадать с Runs/RunSteps; ошибки блокируют приемку.
- **Аудит.**
  - В `Audit` пишутся `ts`, `user_id`, `action(start_open|start_close|handover_open|handover_close|finish_close|step_update)`, `entity`, `entity_id`, `details`.
  - Лог служит расследованиям и контролю доступа; токены и чувствительные данные вне репозитория.

## Открытые вопросы (для уточнения агентами)
1. Финализировать список шагов и обязательность для первого шаблона.
2. Уточнить нормы и пороги дельт по каждому шагу (где строгий ноль, где допускается разброс).
3. Подтвердить список магазинов/менеджеров и Telegram-ID для белого списка.
4. Зафиксировать расписание напоминаний, если нужно отклониться от 11:00 / 16:00 / 19:00.
